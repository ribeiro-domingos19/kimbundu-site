<% layout = "layout" %>
<div class="container" style="padding-top: 20px;">

  <p><a href="/lessons">‚Üê Voltar para todas as aulas</a></p>

  <% if (messages && messages.length > 0) { %>
    <div style="background:#f0f8ff; padding:10px; border:1px solid #cce; border-radius:6px; margin: 10px 0;">
      <% messages.forEach(msg => { %>
        <p style="margin:0;"><%= msg.text %></p>
      <% }) %>
    </div>
  <% } %>

  <% if (successMessage) { %>
    <div style="padding: 10px; margin-bottom: 10px; border: 1px solid #4CAF50; background-color: #e8f5e9; color: #388E3C; border-radius: 4px;">
      <%= successMessage %>
    </div>
  <% } %>

  <% if (errorMessage) { %>
    <div style="padding: 10px; margin-bottom: 10px; border: 1px solid #F44336; background-color: #ffebee; color: #D32F2F; border-radius: 4px;">
      <%= errorMessage %>
    </div>
  <% } %>

  <h2 style="border-bottom: 1px solid #ccc; padding-bottom: 10px;">
    <%= lesson.title %>
  </h2>

  <div style="
        background: #fff;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
        max-height: 75vh;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
  ">
    <%- content %>
  </div>

  <% if (typeof quizResult !== 'undefined' && quizResult) { %>
    <div style="padding: 15px; margin-bottom: 20px; border: 1px solid #4CAF50; background-color: #e8f5e9; color: #388E3C; border-radius: 4px;">
      <strong>Resultado do Quiz:</strong> <%= quizResult.message %> (Pontua√ß√£o: <%= quizResult.score %>/<%= quizResult.total %>)
    </div>
  <% } %>

  <!-- SE√á√ÉO DE FEEDBACK -->
  <div style="background:#f9f9f9; padding:20px; border:1px solid #eee; border-radius:8px; margin-top:25px;">
  <h3>D√∫vidas e Feedback</h3>

  <button id="openModalBtn" style="background-color: #00bcd4; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer;">
    Ver/Enviar Feedback (<%= comments.length %>)
  </button>
</div>
<p style="margin-top: 20px;">
            <a href="/lessons/<%= lesson.id %>/quiz" 
               style="display: inline-block; padding: 10px 15px; background-color: #f39c12; color: white; text-decoration: none; border-radius: 4px; font-weight: bold;">
                Fazer o Quiz da Aula
            </a>
        </p>

<div id="feedbackModal" style="
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.7);
  align-items: center;
  justify-content: center;
">
  <div style="
    background-color: #fefefe;
    margin: auto;
    padding: 25px;
    border: 1px solid #888;
    width: 90%;
    max-width: 700px;
    border-radius: 10px;
  ">
    <h3 style="border-bottom: 2px solid #eee; padding-bottom: 10px;">Feedback e D√∫vidas - Aula <%= lesson.id %></h3>

    <h4 style="margin-top: 20px;">Enviar sua D√∫vida/Feedback</h4>
    <form action="/lessons/<%= lesson.id %>/feedback" method="POST" style="margin-bottom: 30px;">
        <textarea name="message" placeholder="Deixe sua d√∫vida/feedback..." rows="3" style="width: 100%; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px;" required></textarea>
        <button type="submit" style="background-color: #00bcd4; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer;">
            Enviar Feedback
        </button>
    </form>

    <h4 style="border-bottom: 1px solid #ccc; padding-bottom: 5px;">Coment√°rios Anteriores (<%= comments.length %>)</h4>

    <div style="max-height: 400px; overflow-y: auto; padding-right: 15px;">
        <% if (comments && comments.length > 0) { %>
            <% comments.forEach(comment => { %>
                <div style="border: 1px solid #ccc; padding: 15px; margin-bottom: 15px; border-radius: 6px; background: #fff; <%= comment.adminResponse ? 'border-color: #00bcd4; background: #f0f8ff;' : '' %>">

                    <p style="font-size: 14px; color: #555; margin-bottom: 10px;">
                        <strong><%= comment.username === user.username ? 'Voc√™' : comment.username %></strong>
                        em <%= new Date(comment.timestamp).toLocaleString() %>

                        <span style="float: right; font-weight: bold; color: <%= comment.adminResponse ? '#00bcd4' : '#ff9800' %>;">
                            <%= comment.adminResponse ? '‚úÖ Respondido' : 'üïí Pendente' %>
                        </span>
                    </p>

                    <blockquote style="margin: 0; padding: 10px; border-left: 3px solid #ffcc80; font-style: italic; background: #fff3e0; border-radius: 4px;">
                        <%= comment.message %>
                    </blockquote>

                    <% if (comment.adminResponse) { %>
                        <div style="margin-top: 15px; padding: 10px; border: 1px dashed #00bcd4; background: #e0f7fa; border-radius: 4px;">
                            <h4 style="margin-bottom: 5px; color: #00838f;">
                                Resposta do Administrador (<%= comment.adminName || 'Admin' %>):
                            </h4>
                            <p style="margin: 0; white-space: pre-wrap;"><%= comment.adminResponse %></p>
                        </div>
                    <% } %>
                </div>
            <% }) %>
        <% } else { %>
            <p style="color: #777;">Nenhum coment√°rio enviado ainda para esta aula.</p>
        <% } %>
    </div>


    <button id="closeModalBtn" style="margin-top:15px; padding:8px 12px; background:#f44336; color:white; border:none; border-radius:4px; cursor:pointer;">
      Fechar
    </button>
  </div>
</div>

<script>
  const openModalBtn = document.getElementById('openModalBtn');
  const closeModalBtn = document.getElementById('closeModalBtn');
  const feedbackModal = document.getElementById('feedbackModal');

  if (openModalBtn && feedbackModal) {
    openModalBtn.addEventListener('click', () => {
      feedbackModal.style.display = 'flex';
    });
  }

  if (closeModalBtn && feedbackModal) {
    closeModalBtn.addEventListener('click', () => {
      feedbackModal.style.display = 'none';
    });
  }

  // Fecha o modal se clicar fora da caixa
  window.addEventListener('click', (event) => {
    if (event.target === feedbackModal) {
      feedbackModal.style.display = 'none';
    }
  });
</script>
</div>
